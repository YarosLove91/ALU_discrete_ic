# Лабораторная работа "Исследование программного процессора biRISC-V"

## Цель работы
Ознакомление с архитектурой 32-битного RISC-процессора biRISC-V, изучение его системы команд и приобретение практических навыков программирования на ассемблере RISC-V.

## 1. Описание процессора biRISC-V

### 1.1 ключевые особенности процессора biRISC-V
biRISC-V - это 32-битный суперскалярный RISC-V процессор со следующими характеристиками:

- 32-разрядное процессорное ядро RISC-V ISA.
- Суперскалярный (с двумя АЛУ) 6- или 7-ступенчатый конвейер.
- Поддержка целочисленных инструкций RISC-V (I), умножения и деления (M), а также расширения инструкций CSR (Z) (RV32IMZicsr).
- Предсказание ветвлений (bimodel/gshare) с настраиваемой глубиной целевого буфера ветвлений (BTB) и стека адреса возврата (RAS).
- 64-битная выборка инструкций, 32-битный доступ к данным.
- 2 x целочисленных ALU (операции: арифметические, сдвига и ветвления).
- 1 x блок хранения с загрузкой, 1 x внеконвейерный делитель.
- Выдача и выполнение до 2 независимых инструкций за цикл.
- Поддерживаются уровни привилегий пользователя, супервизора и машинного режима.
- Базовая поддержка модуля управления памятью (Memory Manage Unit - MMU) - возможность загрузки Linux с эмуляцией атомарных инструкции (RV-A).
- Реализованы базовая спецификация ISA v2.1 и привилегированная спецификация ISA v1.11.
- Верифицированный дизайн с помощью случайных последовательностей инструкций RISCV-DV от Google, используя косимуляцию с моделью ISA C++.
- Поддержка кэша инструкций/данных, интерфейсов шины AXI или тесно связанной памяти (TCM - памяти).
- Настраиваемое количество стадий конвейера, опции пересылки результатов и ресурсы предсказания ветвлений.
- Синтезируемый Verilog 2001, совместимый с Verilator и FPGA.
- Производительность: Coremark: 4.1 CoreMark/МГц и Dhrystone: 1.9 DMIPS/MHz («законные варианты компиляции» / 337 инструкций на итерацию).

### 1.2 Реализация процессора

Процессор biRISC-V реализован в двух вариантах: c использованием тесно связанной (Tightly Coupled Memory, TCM) памятью с фиксированным временем доступа и с использованием ОЗУ, кеша данных и инструкции.  
Дизайны имеют общие модули описание которых представлено в разделе "Общие модули". Описание архитектуры процессора с TCM памятью представлено в разделе ..., описание архитектуры процессора с памятью представлено в разделе ...

riscv_core c подмодулями: issue, frontend, exec, multiplier, csr, lsu, mmu, divider, icache.  

### 1.2.1 Общие модули RLT-дизайнов процессора.

```
riscv_core
├── issue
│ ├── trace_sim
│ ├── regfile
│ └── pipe_ctrl
├── frontend
│ ├── npc
│ ├── fetch
│ └── decode
├── icache
│ ├── data_ram
│ └── reg_ram
├── exec
├── multiplier
├── csr
├── lsu
├── mmu
├── divider
└ [Различающиеся модули]

```

__Функциональное назначение модулей в дизайне с TCM памятью:__

__Основное функциональное назначение:__ 


#### 1.2.2 Реализация процессора с использованием TCM памяти

Тесно связанная память (Tightly Coupled Memory, TCM) является частью адресуемой памяти, физически расположенной на первом уровне иерархии памяти, в непосредственной близости к кэш-памяти первого уровня.

Архитектура RTL-процессора имеет следующую иерархическую структуру:

```
[Модули общие для обоих дизайнов]
├── dport_mux
├── dport_axi
└── tcm_mem
  ├── tcm_mem_ram
  └── tcm_mem_pmem

```
__Функциональное назначение модулей в дизайне с TCM памятью:__
__Основное функциональное назначение:__ 

![](../birisc_v%20description/Images/riscv_tcm_top.png)

#### 1.2.3 Реализация процессора с использованием ОЗУ

Архитектура RTL-процессора имеет следующую иерархическую структуру:

[Модули общие для обоих дизайнов]
├── dcache
├── dcache_core
│ ├── dcache_core_data_ram
│ └── dcache_core_tag_ram
├── dcache_axi
│ ├── dcache_axi_fifo
│ └── dcache_axi_axi
├── dcache_mux
├── dcache_ifpem_mux
└── dcache_ifpem


Структурная схема дизайна с использованием кешей представлена на изображении xxx

![](../birisc_v%20description/Images/riscv_top.png)

# Таблица сигналов процессора biRISC-V с размерностями

| Сигнал                    | Направление | Размерность (биты) | Описание                                                                 |
|---------------------------|-------------|--------------------|-----------------------------------------|
| **Тактирование и сброс**  |             |                    |                                         |
| clk_i                     | Вход        | 1                  | Тактовый сигнал                         |
| rst_i                     | Вход        | 1                  | Сигнал сброса                           |
| **Интерфейс памяти данных** |           |                    |                                         |
| mem_d_data_rd_i           | Вход        | 32                 | Данные чтения из памяти данных          |
| mem_d_accept_i            | Вход        | 1                  | Подтверждение приема запроса данных     |
| mem_d_ack_i               | Вход        | 1                  | Подтверждение выполнения запроса        |
| mem_d_error_i             | Вход        | 1                  | Ошибка доступа к данным                 |
| mem_d_resp_tag_i          | Вход        | 11                 | Тег ответа данных                       |
| mem_d_addr_o              | Выход       | 32                 | Адрес данных                            |
| mem_d_data_wr_o           | Выход       | 32                 | Данные для записи                       |
| mem_d_rd_o                | Выход       | 1                  | Сигнал чтения данных                    |
| mem_d_wr_o                | Выход       | 4                  | Сигналы записи данных (по байтам)       |
| **Интерфейс памяти инструкций** |       |                    |                                         |
| mem_i_inst_i              | Вход        | 64                 | Инструкции из памяти (2x32-битные)      |
| mem_i_accept_i            | Вход        | 1                  | Подтверждение приема запроса инструкций |
| mem_i_valid_i             | Вход        | 1                  | Действительные данные инструкций        |
| mem_i_error_i             | Вход        | 1                  | Ошибка доступа к инструкциям            |
| mem_i_rd_o                | Выход       | 1                  | Сигнал чтения инструкций                |
| mem_i_flush_o             | Выход       | 1                  | Сброс кэша инструкций                   |
| mem_i_invalidate_o        | Выход       | 1                  | Инвалидация кэша инструкций             |
| mem_i_pc_o                | Выход       | 32                 | Адрес инструкции                        |
| **Системные сигналы**     |             |                    |                                         |
| intr_i                    | Вход        | 1                  | Вход прерывания                         |
| reset_vector_i            | Вход        | 32                 | Вектор сброса                           |
| cpu_id_i                  | Вход        | 32                 | Идентификатор CPU                       |
| **Управление кэшем**      |             |                    |                                         |
| mem_d_cacheable_o         | Выход       | 1                  | Флаг кэшируемости                       |
| mem_d_req_tag_o           | Выход       | 11                 | Тег запроса данных                      |
| mem_d_invalidate_o        | Выход       | 1                  | Инвалидация кэша                        |
| mem_d_writeback_o         | Выход       | 1                  | Запись обратно                          |
| mem_d_flush_o             | Выход       | 1                  | Сброс кэша                              |

## Ключевые внутренние сигналы

| Сигнал                    | Размерность | Описание                                |
|---------------------------|-------------|--------------------------------------------------------------------------|
| mmu_ifetch_inst_w         | 64          | Выбранные инструкции от MMU            |
| fetch0_instr_w            | 32          | Инструкция 0-го потока                 |
| fetch1_instr_w            | 32          | Инструкция 1-го потока                 |
| opcode0_opcode_w          | 32          | Декодированная инструкция потока 0     |
| opcode1_opcode_w          | 32          | Декодированная инструкция потока 1     |
| writeback_exec0_value_w   | 32          | Результат выполнения ALU потока 0      |
| writeback_exec1_value_w   | 32          | Результат выполнения ALU потока 1      |
| branch_pc_w               | 32          | Адрес перехода                        |
| mmu_satp_w                | 32          | Регистр управления MMU                 |

## Особенности размерностей:
1. **Двойная выборка инструкций**: 64-битный интерфейс (mem_i_inst_i) позволяет загружать 2x32-битные инструкции за такт
2. **Теги транзакций**: 11-битные теги (req_tag/resp_tag) для идентификации операций с памятью
3. **Байтовая адресация**: 4-битный mem_d_wr_o позволяет управлять записью отдельных байтов
4. **Двухпоточная архитектура**: дублированные сигналы (exec0/exec1, fetch0/fetch1) для параллельного исполнения
5. **Полная 32-битная адресация**: все адресные сигналы (pc, addr) имеют разрядность 32 бита

> Примечание: Все сигналы данных и адресов используют 32-битную разрядность, соответствующую архитектуре RV32

# Таблица сигналов модуля biriscv_issue

## Параметры модуля

| Параметр                  | Значение по умолчанию | Описание                                      |
|---------------------------|-----------------------|-----------------------------------------------|
| SUPPORT_MULDIV            | 1                     | Поддержка операций умножения/деления          |
| SUPPORT_DUAL_ISSUE        | 1                     | Поддержка двухпоточного исполнения            |
| SUPPORT_LOAD_BYPASS       | 1                     | Поддержка обхода загрузки                     |
| SUPPORT_MUL_BYPASS        | 1                     | Поддержка обхода умножения                    |
| SUPPORT_REGFILE_XILINX    | 0                     | Использование регистрового файла Xilinx       |

## Входные сигналы

| Сигнал                    | Размерность | Описание                                      |
|---------------------------|-------------|-----------------------------------------------|
| **Тактирование и сброс**  |             |                                               |
| clk_i                     | 1           | Тактовый сигнал                               |
| rst_i                     | 1           | Сигнал сброса                                 |
| **Интерфейс выборки**     |             |                                               |
| fetch0_valid_i            | 1           | Валидность инструкции 0                       |
| fetch0_instr_i            | 32          | Инструкция 0 |
| fetch0_pc_i               | 32          | Адрес инструкции 0                            |
| fetch1_valid_i            | 1           | Валидность инструкции 1                       |
| fetch1_instr_i            | 32          | Инструкция 1 |
| fetch1_pc_i               | 32          | Адрес инструкции 1                            |
| **Информация о ветвлениях** |           |                                               |
| branch_exec0_request_i    | 1           | Запрос ветвления от потока 0                  |
| branch_exec1_request_i    | 1           | Запрос ветвления от потока 1                  |
| **Результаты выполнения** |             |                                               |
| writeback_exec0_value_i   | 32          | Результат ALU потока 0                        |
| writeback_exec1_value_i   | 32          | Результат ALU потока 1                        |
| writeback_mem_value_i     | 32          | Результат LSU                                 |
| writeback_mul_value_i     | 32          | Результат умножения                           |
| writeback_div_value_i     | 32          | Результат деления                             |

## Выходные сигналы

| Сигнал                    | Размерность | Описание                                      |
|---------------------------|-------------|-----------------------------------------------|
| **Управление выборкой**   |             |                                               |
| fetch0_accept_o           | 1           | Подтверждение приема инструкции 0             |
| fetch1_accept_o           | 1           | Подтверждение приема инструкции 1             |
| **Интерфейс исполнительных устройств** |       |                                        |
| exec0_opcode_valid_o      | 1           | Валидность инструкции для потока 0            |
| exec1_opcode_valid_o      | 1           | Валидность инструкции для потока 1            |
| lsu_opcode_valid_o        | 1           | Валидность инструкции для LSU                 |
| **Декодированные инструкции** |         |                                               |
| opcode0_opcode_o          | 32          | Декодированная инструкция потока 0            |
| opcode1_opcode_o          | 32          | Декодированная инструкция потока 1            |
| **Информация о регистрах** |            |                                               |
| opcode0_rd_idx_o          | 5           | Индекс регистра назначения потока 0           |
| opcode0_ra_idx_o          | 5           | Индекс регистра источника A потока 0          |
| opcode0_rb_idx_o          | 5           | Индекс регистра источника B потока 0          |

## Внутренние сигналы

| Сигнал                    | Размерность | Описание                                      |
|---------------------------|-------------|-----------------------------------------------|
| **Управление конвейером** |             |                                               |
| pipe0_stall_raw_w         | 1           | Сигнал остановки потока 0                     |
| pipe1_stall_raw_w         | 1           | Сигнал остановки потока 1                     |
| **Регистровый файл**      |             |                                               |
| issue_a_ra_value_w        | 32          | Значение регистра A потока 0                  |
| issue_a_rb_value_w        | 32          | Значение регистра B потока 0                  |
| issue_b_ra_value_w        | 32          | Значение регистра A потока 1                  |
| issue_b_rb_value_w        | 32          | Значение регистра B потока 1                  |
| **Состояние выполнения**  |             |                                               |
| pipe0_load_e1_w           | 1           | Флаг операции загрузки в стадии E1 потока 0   |
| pipe0_mul_e1_w            | 1           | Флаг операции умножения в стадии E1 потока 0  |
| pipe1_load_e1_w           | 1           | Флаг операции загрузки в стадии E1 потока 1   |

## Ключевые особенности:
1. **Двухпоточная архитектура**: Поддержка одновременной выдачи двух инструкций (dual-issue)
2. **Регистровый файл**: 2 порта записи и 4 порта чтения (2W4R)
3. **Обходные пути**: Поддержка обхода результатов операций для минимизации простоев
4. **Управление конвейером**: Сложная логика остановок и сбросов конвейера
5. **Поддержка исключений**: Обработка ошибок выполнения и страничных нарушений

> Примечание: Все сигналы данных и адресов используют 32-битную разрядность, соответствующую архитектуре RV32
>
> 