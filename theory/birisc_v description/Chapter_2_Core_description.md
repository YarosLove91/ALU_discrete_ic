# Лабораторная работа "Исследование программного процессора biRISC-V"

## Цель работы
Ознакомление с архитектурой 32-битного RISC-процессора biRISC-V, изучение его системы команд и приобретение практических навыков программирования на процессорной архитектуры RISC-V.

## 1.1 Описание процессора biRISC-V и его ключевые особенности

### 1.1.1 Описание процессора

biRISC-V это 32-битный суперскалярный процессор RISC-V  с возможностью выполнений двух инструкицй. Данный процессор поддерживает базовый набор целочисленных инструкций RV32IMZicsr, операции умножения и деления, а также работу с контрольными регистрами.
Архитектура процессора основана на конвейере с 6 или 7 этапами, что обеспечивает предсказуемость выполнения программ. Особенностью biriscv является реализация механизма dual-issue, позволяющего за один такт выпускать на исполнение две независимые инструкции. Для повышения эффективности работы с условными переходами в ядре используется гибридный алгоритм предсказания ветвлений, дополненный буфером адресов переходов и стеком возвратов. 
Дизайн процессора имеют высокофункциональное интегрированное окружение для программы Verilator, что позволяет гибко внедрять требуемый функционал.   

### 1.1.2 Ключевые особенности процессора biRISC-V

Для дизайна процессора biRISC-V характерны следующие особенности:

- 32-разрядное процессорное ядро RISC-V ISA;
- Суперскалярная in-order микроархитектура с конфигурируемым 6/7-стадийным конвейером;
- Двухканальный (dual-issue) диспетчер инструкций;
- Поддержка целочисленных инструкций RISC-V (I), умножения и деления (M), а также расширения инструкций CSR (Z) (RV32IMZicsr);
- Гибридный предсказатель (bimodal/gshare) с настраиваемой глубиной целевого буфера ветвлений (BTB) и стека адреса возврата (RAS);
- 64-битная выборка инструкций, 32-битный доступ к данным;
- 2 x целочисленных ALU (операции: арифметические, сдвига и ветвления);
- 1 x блок хранения с загрузкой, 1 x внеконвейерный делитель;
- Выдача и выполнение до 2 независимых инструкций за цикл;
- Поддерживаются уровни привилегий пользователя, супервизора и машинного режима;
- Базовая поддержка модуля управления памятью (Memory Manage Unit - MMU) - возможность загрузки Linux с эмуляцией атомарных инструкции (RV-A);
- Реализованы базовая спецификация ISA v2.1 и привилегированная спецификация ISA v1.11;
- Верифицированный дизайн с помощью случайных последовательностей инструкций RISCV-DV от Google, используя косимуляцию с моделью ISA C++;
- Поддержка кэша инструкций/данных, интерфейсов шины AXI или тесно связанной памяти (TCM - памяти);
- Настраиваемое количество стадий конвейера, опции пересылки результатов и ресурсы предсказания ветвлений;
- Синтезируемый Verilog 2001, совместимый с Verilator и аппаратной реализации на FPGA;
- Производительность: Coremark: 4.1 CoreMark/МГц и Dhrystone: 1.9 DMIPS/MHz (Поддержка "legal compile options" для эталонных тестов / 337 инструкций на итерацию).

### 1.2 Реализация процессора

Дизайн процессора biRISC-V реализован в двух вариантах: 
1. С использованием тесно связанной памятью - TCM (Tightly Coupled Memory, TCM) с фиксированным временем доступа;  
2. С использованием ОЗУ, кеша данных (__dcashe__) и кеша инструкции (__icashe__).  
 
Дизайны имеют общие модули описание которых представлено в разделе "Общие модули". Описание архитектуры процессора с TCM памятью представлено в разделе ..., описание архитектуры процессора с памятью представлено в разделе ...

riscv_core c подмодулями: issue, frontend, exec, multiplier, csr, lsu, mmu, divider, icache.  

### 1.2.1 Общие модули RLT-дизайнов процессора.

```
riscv_core
├── u_issue
│ ├── trace_sim
│ ├── regfile
│ └── pipe_ctrl
├── u_frontend
│ ├── npc
│ ├── fetch
│ └── decode
├── exec0
├── exec1
├── u_csr
│ └── biriscv_csr_regfile
├── u_lsu
│ └── biriscv_lsu_fifo
├── u_multiplier
├── u_divider
├── u_mmu
└ [Различающиеся модули]

```

__Модуль riscv_core__

## Особенности размерностей:
1. **Двойная выборка инструкций**: 64-битный интерфейс (mem_i_inst_i) позволяет загружать 2x32-битные инструкции за такт
2. **Теги транзакций**: 11-битные теги (req_tag/resp_tag) для идентификации операций с памятью
3. **Байтовая адресация**: 4-битный mem_d_wr_o позволяет управлять записью отдельных байтов
4. **Двухпоточная архитектура**: дублированные сигналы (exec0/exec1, fetch0/fetch1) для параллельного исполнения
5. **Полная 32-битная адресация**: все адресные сигналы (pc, addr) имеют разрядность 32 бита

> Примечание: Все сигналы данных и адресов используют 32-битную разрядность, соответствующую архитектуре RV32


__Подмодуль issue__

Модуль biriscv_issue является критически важным компонентом суперскалярного процессора biRISC-V, выполняющим функцию __диспетчера инструкций__ (instruction scheduler). Его основное назначение и ключевые функции:

1. Основная задача

Управление конвейерной обработкой инструкций:  
1.1 Выборка и распределение инструкций по исполнительным устройствам (ALU, LSU, MUL/DIV и др.)  
1.2 Контроль зависимостей между инструкциями  
1.3 Реализация двухпоточного исполнения (dual-issue)  

2. Ключевые функции

2.1 Декодирование - анализ поступающих инструкций и определение их типа (ALU, LSU, Branch и т.д.);
2.2 Распределение - назначение инструкций свободным исполнительным блокам;
2.3 Управление зависимостями	- отслеживание RAW/WAW-зависимостей;
2.4 Обходные пути	- формирование bypass-путей для результатов операций;
2.5 Контроль потока	- обработка ветвлений, исключений и прерываний.

Таблица сигналов модуля biriscv_issue

Параметры модуля biriscv_issue

| Параметр                  | Значение по умолчанию | Описание                                      |
|---------------------------|-----------------------|-----------------------------------------------|
| SUPPORT_MULDIV            | 1                     | Поддержка операций умножения/деления          |
| SUPPORT_DUAL_ISSUE        | 1                     | Поддержка двухпоточного исполнения            |
| SUPPORT_LOAD_BYPASS       | 1                     | Поддержка обхода загрузки                     |
| SUPPORT_MUL_BYPASS        | 1                     | Поддержка обхода умножения                    |
| SUPPORT_REGFILE_XILINX    | 0                     | Использование регистрового файла Xilinx       |

## Ключевые особенности:
1. **Двухпоточная архитектура**: Поддержка одновременной выдачи двух инструкций (dual-issue)
2. **Регистровый файл**: 2 порта записи и 4 порта чтения (2W4R)
3. **Обходные пути**: Поддержка обхода результатов операций для минимизации простоев
4. **Управление конвейером**: Сложная логика остановок и сбросов конвейера
5. **Поддержка исключений**: Обработка ошибок выполнения и страничных нарушений

> Примечание: Все сигналы данных и адресов используют 32-битную разрядность, соответствующую архитектуре RV32

__Подмодуль frontend__

# Описание модуля biriscv_frontend - Frontend процессора biRISC-V

## Общее назначение
Модуль `biriscv_frontend` является фронтенд-частью процессора biRISC-V, отвечающей за:
- Предвыборку инструкций
- Предсказание ветвлений
- Декодирование инструкций
- Управление кешем инструкций

## Параметры модуля

| Параметр                     | Описание |
|------------------------------|----------|
| `SUPPORT_BRANCH_PREDICTION`  | Поддержка предсказания ветвлений |
| `SUPPORT_MULDIV`             | Поддержка инструкций умножения/деления |
| `SUPPORT_MMU`                | Поддержка MMU |
| `EXTRA_DECODE_STAGE`         | Дополнительный этап декодирования |
| `NUM_BTB_ENTRIES`            | Количество записей в BTB |
| `NUM_BHT_ENTRIES`           | Количество записей в BHT |
| `RAS_ENABLE`                | Включение Return Address Stack |
| `GSHARE_ENABLE`             | Включение Gshare-предсказателя |
| `BHT_ENABLE`                | Включение Branch History Table |
| `NUM_RAS_ENTRIES`           | Глубина Return Address Stack |


## Внутренняя структура

### Подмодули:
1. **biriscv_npc** - Модуль предсказания следующего PC:
   - Реализует BTB (Branch Target Buffer)
   - Поддерживает BHT (Branch History Table)
   - Включает RAS (Return Address Stack)
   - Поддерживает Gshare-предсказатель

2. **biriscv_decode** - Модуль декодирования:
   - Декодирует инструкции RISC-V
   - Определяет тип инструкции (исполнение, память, ветвление и т.д.)
   - Поддерживает двухпотоковую выдачу инструкций (fetch0 и fetch1)

3. **biriscv_fetch** - Модуль выборки:
   - Управляет предвыборкой инструкций
   - Обрабатывает страничные ошибки
   - Взаимодействует с кешем инструкций

## Особенности работы
1. **Предсказание ветвлений**:
   - Использует комбинацию BTB, BHT и RAS
   - Поддерживает как условные, так и безусловные переходы
   - Обрабатывает вызовы и возвраты из подпрограмм

2. **Декодирование**:
   - Определяет 7 типов инструкций:
     * `_exec_o` - арифметико-логические
     * `_lsu_o` - работа с памятью
     * `_branch_o` - ветвления
     * `_mul_o`, `_div_o` - умножение/деление
     * `_csr_o` - работа с CSR
     * `_rd_valid_o` - наличие записи в регистр
     * `_invalid_o` - невалидная инструкция

3. **Двухпотоковая выдача**:
   - Позволяет выдавать до 2 инструкций за такт
   - Каждый поток имеет отдельные сигналы готовности

## Взаимодействие с другими модулями
1. **С кешем инструкций**:
   - Управляет чтением (`icache_rd_o`)
   - Обрабатывает ошибки (`icache_error_i`)
   - Управляет инвалидацией (`icache_invalidate_o`)

2. **С backend-частью**:
   - Передает декодированные инструкции
   - Получает информацию о реальных ветвлениях
   - Обновляет предсказатели на основе фактических переходов

Модуль оптимизирован для баланса между производительностью и площадью, с возможностью тонкой настройки через параметры.

### Особенности сигналов:
1. **Двойная выборка**:
   - 64-битный `fetch_instr_w` содержит 2 инструкции для dual-issue
   - Раздельные флаги валидности для каждого потока (`fetch0_valid_o`, `fetch1_valid_o`)

2. **Прогнозирование переходов**:
   - `next_taken_f_w` использует 2 бита для кодирования:
     * 00 - ветвление не взято
     * 01 - ветвление взято
     * 10 - безусловный переход
   - `fetch_pred_branch_w` сохраняет историю для BHT

3. **Конвейерная обработка**:
   - `fetch_accept_w` управляет потоком инструкций
   - `fetch_pc_accept_w` синхронизирует работу с NPC

4. **Обработка ошибок**:
   - Двойные флаги fault (fetch/page) для каждого конвейера
   - Интеграция с MMU через `icache_page_fault_i`

5. **Привилегированный режим**:
   - `icache_priv_o` передает текущий уровень привилегий (U/S/M) в кеш


__Подмудуль exec__

Модуль biriscv_exec - Execution Unit RISC-V CPU


## Поддерживаемые инструкции

### Арифметико-логические
- `ADD`, `SUB`, `AND`, `OR`, `XOR`
- `SLT`, `SLTU` (сравнения)
- `SLL`, `SRL`, `SRA` (сдвиги)
- `ADDI`, `ANDI`, `ORI`, `XORI`, `SLTI`, `SLTIU`
- `SLLI`, `SRLI`, `SRAI`
- `LUI`, `AUIPC`

### Ветвления и переходы
- `BEQ`, `BNE`, `BLT`, `BGE`, `BLTU`, `BGEU`
- `JAL`, `JALR` (с обработкой call/ret)

__Подмодуль u_csr__

# Описание модуля biriscv_csr - модуль управления CSR (Control and Status Registers) в процессоре biRISC-V

## Общее назначение
Модуль `biriscv_csr` отвечает за:
- Управление регистрами состояния и контроля (CSR)
- Обработку исключений и прерываний
- Управление привилегированными режимами работы
- Взаимодействие с MMU (Memory Management Unit)
- Обработку специальных инструкций (ECALL, EBREAK, ERET и др.)

## Параметры модуля

| Параметр            | Описание |
|---------------------|----------|
| `SUPPORT_MULDIV`    | Поддержка инструкций умножения/деления |
| `SUPPORT_SUPER`     | Поддержка супервизорного режима (S-mode) |

## Основные функции

### 1. Обработка CSR-инструкций
Поддерживает все стандартные CSR-инструкции RISC-V:
- `CSRRW`, `CSRRS`, `CSRRC` - чтение/запись CSR
- `CSRRWI`, `CSRRSI`, `CSRRCI` - чтение/запись CSR с immediate-значением
- Проверяет привилегии доступа к CSR

### 2. Обработка специальных инструкций
- `ECALL` - вызов исключения
- `EBREAK` - точка останова
- `ERET` - возврат из исключения
- `WFI` - ожидание прерывания
- `FENCE`, `SFENCE`, `IFENCE` - барьеры памяти

### 3. Управление прерываниями и исключениями
- Формирует сигнал `take_interrupt_o` для обработки прерываний
- Генерирует коды исключений:
  - `EXCEPTION_ECALL`
  - `EXCEPTION_ERET`
  - `EXCEPTION_BREAKPOINT`
  - `EXCEPTION_ILLEGAL_INSTRUCTION`
  - `EXCEPTION_FENCE`

### 4. Управление привилегиями
Поддерживает 3 уровня привилегий (M/S/U режимы):
- Контролирует переходы между режимами
- Проверяет права доступа к CSR
- Управляет регистром `mstatus`

### 5. Взаимодействие с MMU
- Управляет регистром `satp` (режим трансляции адресов)
- Формирует сигналы:
  - `mmu_priv_d_o` - текущий режим привилегий для MMU
  - `mmu_satp_o` - значение регистра SATP
  - `mmu_flush_o` - запрос на сброс TLB
  - `mmu_sum_o`, `mmu_mxr_o` - флаги доступа к памяти

## Внутренняя структура

### Подмодули:
1. **biriscv_csr_regfile** - Регистровый файл CSR:
   - Содержит все стандартные CSR регистры RISC-V
   - Обрабатывает чтение/запись регистров
   - Управляет прерываниями и исключениями

### Ключевые внутренние сигналы:
- `current_priv_w` - текущий уровень привилегий
- `status_reg_w` - значение регистра статуса
- `satp_reg_w` - значение регистра SATP
- `interrupt_w` - маска прерываний

## Особенности реализации
1. **Обработка исключений**:
   - Исключения обнаруживаются на стадии E1 (раннее декодирование)
   - Сохраняют контекст в соответствующих CSR регистрах

2. **Управление ветвлениями**:
   - Обрабатывает ветвления по исключениям и прерываниям
   - Формирует целевой адрес перехода (`branch_csr_pc_o`)

3. **Барьеры памяти**:
   - `FENCE` - синхронизация памяти
   - `SFENCE` - сброс TLB
   - `IFENCE` - сброс конвейера инструкций

Модуль обеспечивает полную поддержку стандарта RISC-V для работы с CSR и обработки исключений, с возможностью конфигурации через параметры.

__Подмодуль u_lsu__

# Описание модуля biriscv_lsu - модуль загрузки/сохранения (Load/Store Unit) в процессоре biRISC-V

## Общее назначение
Модуль `biriscv_lsu` отвечает за:
- Обработку инструкций загрузки (load) и сохранения (store)
- Работу с памятью через интерфейс кэша данных
- Обработку невыровненных (unaligned) доступов
- Генерацию исключений при ошибках доступа к памяти
- Управление операциями с кэшем (инвалидация, сброс и др.)

## Параметры модуля

| Параметр                | Описание |
|-------------------------|----------|
| `MEM_CACHE_ADDR_MIN`    | Минимальный адрес кэшируемой памяти |
| `MEM_CACHE_ADDR_MAX`    | Максимальный адрес кэшируемой памяти |

## Основные функции

### 1. Обработка инструкций загрузки/сохранения
Поддерживает все стандартные инструкции RISC-V:
- Загрузки: `LB`, `LH`, `LW`, `LBU`, `LHU`, `LWU`
- Сохранения: `SB`, `SH`, `SW`
- Обрабатывает знаковые и беззнаковые варианты

### 2. Работа с памятью
- Формирует адреса для доступа
- Генерирует маски записи для операций разной ширины
- Обрабатывает ответы от подсистемы памяти

### 3. Обработка невыровненных доступов
- Обнаруживает невыровненные доступы (для полуслов и слов)
- Генерирует соответствующие исключения

### 4. Управление кэшем
- Поддерживает операции:
  - Инвалидация (`mem_invalidate_o`)
  - Запись обратно (`mem_writeback_o`)
  - Полный сброс (`mem_flush_o`)
- Определяет кэшируемость адресов (`mem_cacheable_o`)

### 5. Генерация исключений
- Ошибки выравнивания:
  - `EXCEPTION_MISALIGNED_LOAD`
  - `EXCEPTION_MISALIGNED_STORE`
- Ошибки страниц:
  - `EXCEPTION_PAGE_FAULT_LOAD`
  - `EXCEPTION_PAGE_FAULT_STORE`
- Ошибки шины:
  - `EXCEPTION_FAULT_LOAD`
  - `EXCEPTION_FAULT_STORE`

## Внутренняя структура

### Подмодули:
1. **biriscv_lsu_fifo** - FIFO буфер для отслеживания запросов:
   - Глубина 2 записи
   - Хранит информацию о выполняемых операциях

### Ключевые внутренние сигналы:
- `pending_lsu_e2_q` - флаг ожидания завершения запроса
- `mem_unaligned_e1_q` - флаг невыровненного доступа
- `mem_load_q` - флаг операции загрузки
- `mem_xb_q`, `mem_xh_q` - флаги операций с байтами и полусловами

## Особенности реализации

1. **Обработка запросов**:
   - Поддерживает конвейеризацию запросов
   - Обеспечивает правильное упорядочивание операций

2. **Формирование результата**:
   - Для операций загрузки выполняет расширение знака
   - Корректно обрабатывает доступы к разным байтам слова

3. **Управление потоком**:
   - Генерирует сигнал `stall_o` при необходимости остановки конвейера
   - Обрабатывает задержки ответов от памяти

4. **Специальные операции**:
   - Поддерживает CSR-инструкции для управления кэшем
   - Обрабатывает барьеры памяти

Модуль обеспечивает полную поддержку стандарта RISC-V для операций загрузки и сохранения с эффективным управлением памятью и обработкой ошибок.

__Подмодуль u_multiplier__

# Описание модуля biriscv_multiplier - модуль умножения в процессоре biRISC-V

## Общее назначение
Модуль `biriscv_multiplier` реализует операции умножения для процессора biRISC-V, поддерживая все варианты умножения согласно стандарту RISC-V:
- Обычное умножение (MUL)
- Умножение с получением старшей части результата (MULH)
- Смешанные знаковые варианты (MULHSU)
- Беззнаковое умножение (MULHU)

## Параметры модуля

| Параметр         | Описание |
|------------------|----------|
| `MULT_STAGES`    | Количество конвейерных стадий (2 или 3) |

## Входные сигналы

| Сигнал                  | Размерность | Описание |
|-------------------------|-------------|----------|
| `clk_i`, `rst_i`       | 1 бит       | Такт и сброс |
| `opcode_*`             | Различная   | Информация о текущей инструкции |
| `opcode_ra_operand_i`  | 32 бита     | Первый операнд (rs1) |
| `opcode_rb_operand_i`  | 32 бита     | Второй операнд (rs2) |
| `hold_i`               | 1 бит       | Сигнал остановки конвейера |

## Выходные сигналы

| Сигнал               | Размерность | Описание |
|----------------------|-------------|----------|
| `writeback_value_o`  | 32 бита     | Результат умножения |

## Поддерживаемые инструкции

| Инструкция | Описание |
|------------|----------|
| `MUL`      | Умножение (младшие 32 бита) |
| `MULH`     | Умножение со знаком (старшие 32 бита) |
| `MULHSU`   | Умножение rs1 со знаком, rs2 без знака (старшие 32 бита) |
| `MULHU`    | Умножение без знака (старшие 32 бита) |

## Внутренняя структура

### Ключевые регистры:
- `operand_a_e1_q`, `operand_b_e1_q` - входные операнды (33 бита с учетом знака)
- `mulhi_sel_e1_q` - флаг выбора старшей части результата
- `result_e2_q`, `result_e3_q` - конвейерные регистры результата

### Основные логические блоки:
1. **Подготовка операндов**:
   - Для `MULHSU`: rs1 со знаком (33 бита), rs2 без знака (32 бита + 0)
   - Для `MULH`: оба операнда со знаком (33 бита)
   - Для `MUL`/`MULHU`: оба операнда без знака (32 бита + 0)

2. **Умножение**:
   - 33-битные операнды расширяются до 65 бит с учетом знака
   - Выполняется умножение 65x65 бит (`mult_result_w`)

3. **Выбор результата**:
   - Для `MUL`: младшие 32 бита (`mult_result_w[31:0]`)
   - Для остальных инструкций: старшие 32 бита (`mult_result_w[63:32]`)

## Особенности реализации

1. **Конвейеризация**:
   - Поддерживает 2 или 3 стадии конвейера (задается параметром `MULT_STAGES`)
   - Регистры `result_e2_q` и `result_e3_q` обеспечивают конвейерную обработку

2. **Обработка знаков**:
   - Корректно обрабатывает все комбинации знаковых и беззнаковых операндов
   - Использует расширение знака при необходимости

3. **Управление потоком**:
   - Учитывает сигнал `hold_i` для остановки конвейера
   - Сбрасывает промежуточные регистры по сигналу `rst_i`

4. **Эффективность**:
   - Оптимизированная реализация умножения с минимальным количеством стадий
   - Поддерживает все варианты умножения RISC-V в одном модуле

Модуль обеспечивает полную поддержку стандарта RISC-V для операций умножения с гибкой настройкой глубины конвейера.

__Подмодуль u_divider__
# Описание модуля biriscv_divider - модуль деления в процессоре biRISC-V

## Общее назначение
Модуль `biriscv_divider` реализует операции деления и вычисления остатка для процессора biRISC-V в соответствии со стандартом RISC-V. Поддерживает все варианты операций деления, включая знаковые и беззнаковые версии.

## Входные сигналы

| Сигнал                  | Размерность | Описание |
|-------------------------|-------------|----------|
| `clk_i`, `rst_i`       | 1 бит       | Такт и сброс |
| `opcode_*`             | Различная   | Информация о текущей инструкции |
| `opcode_ra_operand_i`  | 32 бита     | Делимое (rs1) |
| `opcode_rb_operand_i`  | 32 бита     | Делитель (rs2) |

## Выходные сигналы

| Сигнал               | Размерность | Описание |
|----------------------|-------------|----------|
| `writeback_valid_o`  | 1 бит       | Флаг валидности результата |
| `writeback_value_o`  | 32 бита     | Результат операции |

## Поддерживаемые инструкции

| Инструкция | Описание |
|------------|----------|
| `DIV`      | Знаковое деление |
| `DIVU`     | Беззнаковое деление |
| `REM`      | Знаковый остаток от деления |
| `REMU`     | Беззнаковый остаток от деления |

## Внутренняя структура

### Ключевые регистры:
- `dividend_q` - текущее делимое
- `divisor_q` - текущий делитель (сдвигаемый)
- `quotient_q` - накапливаемое частное
- `q_mask_q` - маска для построения частного
- `div_busy_q` - флаг выполнения операции
- `wb_result_q` - результат для записи

### Основные логические блоки:
1. **Декодирование инструкций**:
   - Определение типа операции (деление/остаток, знаковое/беззнаковое)
   - Установка флагов `signed_operation_w` и `div_operation_w`

2. **Подготовка операндов**:
   - Для знаковых операций: вычисление модулей операндов при необходимости
   - Установка флага `invert_res_q` для коррекции знака результата

3. **Алгоритм деления**:
   - Итерационный алгоритм с восстановлением остатка
   - На каждом шаге:
     - Сравнение делителя с текущим остатком
     - Вычитание и обновление частного при необходимости
     - Сдвиг делителя и маски

4. **Коррекция результата**:
   - Инверсия знака результата при необходимости
   - Выбор между частным и остатком

## Особенности реализации

1. **Оптимизация повторных операций**:
   - Запоминание последних операндов и типа операции
   - Пропуск вычислений при повторении тех же параметров

2. **Обработка знаков**:
   - Работа с модулями чисел при знаковых операциях
   - Коррекция знака результата на последнем этапе

3. **Управление состоянием**:
   - Сигнал `div_busy_q` указывает на выполнение операции
   - Сигнал `div_complete_w` отмечает завершение вычислений

4. **Конвейеризация**:
   - Результат сохраняется в регистр `wb_result_q`
   - Сигнал `writeback_valid_o` указывает на готовность результата

5. **Обработка особых случаев**:
   - Корректная обработка знаковых операций
   - Оптимизация для повторяющихся вычислений

Модуль обеспечивает полную поддержку стандарта RISC-V для операций деления и вычисления остатка, с эффективной реализацией итерационного алгоритма деления.

__Подмодуль u_mmu__

# Описание модуля biriscv_mmu - модуль управления памятью (MMU) в процессоре biRISC-V

## Общее назначение
Модуль `biriscv_mmu` реализует механизм виртуальной памяти для процессора biRISC-V, обеспечивая:
- Трансляцию виртуальных адресов в физические
- Защиту памяти через систему привилегий
- Кэширование таблиц страниц (TLB)
- Обработку исключений доступа к памяти

## Параметры модуля

| Параметр                | Описание |
|-------------------------|----------|
| `MEM_CACHE_ADDR_MIN`    | Минимальный адрес кэшируемой памяти |
| `MEM_CACHE_ADDR_MAX`    | Максимальный адрес кэшируемой памяти |
| `SUPPORT_MMU`           | Флаг поддержки MMU (1 - включено) |

## Входные сигналы

### Управление и конфигурация
| Сигнал               | Размерность | Описание |
|----------------------|-------------|----------|
| `clk_i`, `rst_i`    | 1 бит       | Такт и сброс |
| `priv_d_i`          | 2 бита      | Текущий режим привилегий (для данных) |
| `sum_i`             | 1 бит       | Разрешение доступа супервизора к пользовательским страницам |
| `mxr_i`             | 1 бит       | Разрешение исполнения при чтении (Make eXecutable Readable) |
| `flush_i`           | 1 бит       | Сигнал сброса TLB |
| `satp_i`            | 32 бита     | Регистр управления виртуальной памятью |

### Интерфейс выборки инструкций
| Сигнал                  | Размерность | Описание |
|-------------------------|-------------|----------|
| `fetch_in_*`           | Различная   | Запросы на выборку инструкций |
| `fetch_out_*`          | Различная   | Ответы от кэша инструкций |

### Интерфейс загрузки/сохранения
| Сигнал                  | Размерность | Описание |
|-------------------------|-------------|----------|
| `lsu_in_*`             | Различная   | Запросы LSU (Load/Store Unit) |
| `lsu_out_*`            | Различная   | Ответы от кэша данных |

## Выходные сигналы

### Интерфейс выборки инструкций
| Сигнал                  | Размерность | Описание |
|-------------------------|-------------|----------|
| `fetch_in_*`           | Различная   | Ответы на запросы выборки |
| `fetch_out_*`          | Различная   | Запросы к кэшу инструкций |

### Интерфейс загрузки/сохранения
| Сигнал                  | Размерность | Описание |
|-------------------------|-------------|----------|
| `lsu_in_*`             | Различная   | Ответы LSU |
| `lsu_out_*`            | Различная   | Запросы к кэшу данных |
| `lsu_in_load_fault_o`  | 1 бит       | Ошибка загрузки (страничное нарушение) |
| `lsu_in_store_fault_o` | 1 бит       | Ошибка сохранения (страничное нарушение) |

## Основные функции

### 1. Трансляция адресов
- Поддержка двухуровневой таблицы страниц (SV32)
- Обработка 4MB суперстраниц и 4KB страниц
- Кэширование результатов трансляции в TLB

### 2. TLB (Translation Lookaside Buffer)
- Отдельные TLB для инструкций (ITLB) и данных (DTLB)
- Инвалидация по сигналу `flush_i`
- Автоматическое обновление при промахах

### 3. Проверка прав доступа
- Контроль прав на чтение/запись/исполнение
- Учет текущего режима привилегий (`priv_d_i`)
- Обработка флагов `sum_i` и `mxr_i`

### 4. Обработка исключений
- Страничные нарушения (page faults)
- Нарушения прав доступа
- Ошибки выравнивания

### 5. Интерфейс с кэшами
- Трансляция адресов для кэша инструкций
- Трансляция адресов для кэша данных
- Управление кэшируемостью областей памяти

## Внутренняя структура

### Ключевые компоненты:
1. **ITLB (Instruction TLB)**
   - Кэш трансляций для выборки инструкций
   - Проверка прав на исполнение

2. **DTLB (Data TLB)**
   - Кэш трансляций для операций загрузки/сохранения
   - Проверка прав на чтение/запись

3. **Page Table Walker**
   - Аппаратный обход таблицы страниц
   - Поддержка двухуровневой структуры
   - Обработка суперстраниц

4. **Интерфейс запросов**
   - Арбитраж между запросами MMU и процессора
   - Управление приоритетами

## Особенности реализации

1. **Конвейеризация**:
   - Перекрытие обработки TLB-промахов с обычными операциями
   - Оптимизированные пути для частых случаев

2. **Оптимизации**:
   - Предварительная проверка TLB-попаданий
   - Быстрая обработка машинного режима (когда MMU отключен)

3. **Безопасность**:
   - Строгая проверка прав доступа
   - Изоляция пространств пользователя и супервизора

4. **Гибкость**:
   - Возможность отключения MMU через параметр `SUPPORT_MMU`
   - Настраиваемые области кэшируемой памяти

Модуль обеспечивает полную поддержку виртуальной памяти согласно спецификации RISC-V Privileged Architecture.

#### 1.2.2 Реализация процессора с использованием TCM памяти

Тесно связанная память (Tightly Coupled Memory, TCM) является частью адресуемой памяти, физически расположенной на первом уровне иерархии памяти, в непосредственной близости к кэш-памяти первого уровня.

Архитектура RTL-процессора имеет следующую иерархическую структуру:

```
riscv_core[с общими модулями]
├── dport_mux
├── dport_axi
└── tcm_mem
  ├── tcm_mem_ram
  └── tcm_mem_pmem

```
__Функциональное назначение модулей в дизайне с TCM памятью:__
__Основное функциональное назначение:__ 

![](../birisc_v%20description/Images/riscv_tcm_top.png)

__Модуль dport_mux__

Назначение:
Мультиплексирует доступ к памяти между TCM (Tightly Coupled Memory) и внешней памятью (через AXI). Определяет, куда направлять запросы: в быструю TCM-память или внешнюю шину.

Ключевые сигналы:

| Сигнал              | Направление | Тип     | Описание                          |
|---------------------|-------------|---------|-----------------------------------|
| clk_i               | Вход        | 1 бит   | Тактовый сигнал                   |
| rst_i               | Вход        | 1 бит   | Сигнал сброса                     |
| mem_addr_i          | Вход        | [31:0]  | Адрес памяти от ядра              |
| mem_rd_i            | Вход        | 1 бит   | Флаг чтения                       |
| mem_wr_i            | Вход        | [3:0]   | Маска записи                      |
| mem_cacheable_i     | Вход        | 1 бит   | Флаг кешируемости                 |
| mem_tcm_data_rd_i   | Вход        | [31:0]  | Данные из TCM                     |
| mem_ext_data_rd_i   | Вход        | [31:0]  | Данные из внешней памяти          |
| mem_data_rd_o       | Выход       | [31:0]  | Результирующие данные             |
| mem_accept_o        | Выход       | 1 бит   | Подтверждение приёма              |
| mem_tcm_rd_o        | Выход       | 1 бит   | Чтение TCM                        |
| mem_ext_rd_o        | Выход       | 1 бит   | Чтение внешней памяти             |

Логика работы:

Проверяет адрес mem_addr_i на принадлежность к TCM (TCM_MEM_BASE).
Направляет запросы в TCM, если адрес в её диапазоне, иначе — во внешнюю память.
Поддерживает очередь pending-запросов для избежания конфликтов.

__Модуль dport_axi__

Назначение:
Адаптирует интерфейс процессора (чтение/запись) к AXI-шине для доступа к внешней памяти. Поддерживает буферизацию запросов.

Ключевые сигналы:

| Сигнал              | Направление | Тип     | Описание                          |
|---------------------|-------------|---------|-----------------------------------|
| clk_i               | Вход        | 1 бит   | Тактовый сигнал                   |
| rst_i               | Вход        | 1 бит   | Сигнал сброса                     |
| mem_addr_i          | Вход        | [31:0]  | Адрес запроса                     |
| mem_data_wr_i       | Вход        | [31:0]  | Данные для записи                 |
| mem_rd_i            | Вход        | 1 бит   | Флаг чтения                       |
| axi_rdata_i         | Вход        | [31:0]  | Данные чтения AXI                 |
| mem_data_rd_o       | Выход       | [31:0]  | Данные для процессора             |
| axi_awvalid_o       | Выход       | 1 бит   | Валидность адреса записи          |
| axi_awaddr_o        | Выход       | [31:0]  | AXI-адрес записи                  |
| axi_wdata_o         | Выход       | [31:0]  | AXI-данные записи                 |

Логика работы:
    Использует FIFO (u_req, u_resp) для буферизации запросов и ответов.
    Поддерживает 1 outstanding-транзакцию (ожидающий запрос).
    Преобразует простые запросы в AXI-транзакции (чтение/запись, burst-доступ).

__Модуль tcm__

3. Модуль tcm_mem.v

Назначение:
Управляет TCM-памятью, включая доступ к данным (RAM) и инструкциям (PMEM). Поддерживает интерфейсы для ядра и AXI.

Подмодули:

    tcm_mem_ram: Dual-port RAM для данных (64 КБ).
    tcm_mem_pmem: Интерфейс для инструкций и AXI-доступа.

| Сигнал                  | Направление | Тип      | Описание                                                                 |
|-------------------------|-------------|----------|--------------------------------------------------------------------------|
| **Системные сигналы**   |             |          |                                                                          |
| `clk_i`                 | Вход        | 1 бит    | Тактовый сигнал                                                         |
| `rst_i`                 | Вход        | 1 бит    | Асинхронный сброс (активный высокий уровень)                            |
| **Интерфейс инструкций** |           |          |                                                                          |
| `mem_i_rd_i`            | Вход        | 1 бит    | Запрос чтения инструкции                                                |
| `mem_i_flush_i`         | Вход        | 1 бит    | Сигнал сброса кэша инструкций                                           |
| `mem_i_invalidate_i`    | Вход        | 1 бит    | Инвалидация кэша инструкций                                             |
| `mem_i_pc_i`            | Вход        | [31:0]   | Адрес инструкции (Program Counter)                                      |
| `mem_i_accept_o`        | Выход       | 1 бит    | Подтверждение приёма запроса                                            |
| `mem_i_valid_o`         | Выход       | 1 бит    | Валидность данных инструкции                                            |
| `mem_i_error_o`         | Выход       | 1 бит    | Ошибка при чтении инструкции                                            |
| `mem_i_inst_o`          | Выход       | [63:0]   | Прочитанная инструкция (64-бит для поддержки сдвоенных инструкций)      |
| **Интерфейс данных**    |             |          |                                                                          |
| `mem_d_addr_i`          | Вход        | [31:0]   | Адрес данных                                                            |
| `mem_d_data_wr_i`       | Вход        | [31:0]   | Данные для записи                                                       |
| `mem_d_rd_i`            | Вход        | 1 бит    | Флаг чтения данных                                                      |
| `mem_d_wr_i`            | Вход        | [3:0]    | Маска записи (по байтам)                                                |
| `mem_d_cacheable_i`     | Вход        | 1 бит    | Флаг кешируемости                                                       |
| `mem_d_req_tag_i`       | Вход        | [10:0]   | Тег запроса                                                             |
| `mem_d_invalidate_i`    | Вход        | 1 бит    | Инвалидация кэша данных                                                 |
| `mem_d_writeback_i`     | Вход        | 1 бит    | Запрос обратной записи (writeback)                                      |
| `mem_d_flush_i`         | Вход        | 1 бит    | Сброс кэша данных                                                       |
| `mem_d_data_rd_o`       | Выход       | [31:0]   | Прочитанные данные                                                      |
| `mem_d_accept_o`        | Выход       | 1 бит    | Подтверждение приёма запроса                                            |
| `mem_d_ack_o`           | Выход       | 1 бит    | Подтверждение выполнения операции                                       |
| `mem_d_error_o`         | Выход       | 1 бит    | Ошибка при операции с данными                                           |
| `mem_d_resp_tag_o`      | Выход       | [10:0]   | Тег ответа                                                              |
| **AXI-интерфейс**       |             |          |                                                                          |
| `axi_awvalid_i`         | Вход        | 1 бит    | Валидность адреса записи AXI                                            |
| `axi_awaddr_i`          | Вход        | [31:0]   | AXI-адрес записи                                                        |
| `axi_awid_i`            | Вход        | [3:0]    | AXI-ID транзакции записи                                                |
| `axi_awlen_i`           | Вход        | [7:0]    | Длина burst-записи                                                      |
| `axi_awburst_i`         | Вход        | [1:0]    | Тип burst-записи (00-FIXED, 01-INCR, 10-WRAP)                           |
| `axi_wvalid_i`          | Вход        | 1 бит    | Валидность данных записи                                                |
| `axi_wdata_i`           | Вход        | [31:0]   | AXI-данные записи                                                       |
| `axi_wstrb_i`           | Вход        | [3:0]    | Маска записи AXI                                                        |
| `axi_wlast_i`           | Вход        | 1 бит    | Флаг последнего пакета в burst                                          |
| `axi_bready_i`          | Вход        | 1 бит    | Готовность принять ответ записи                                         |
| `axi_arvalid_i`         | Вход        | 1 бит    | Валидность адреса чтения AXI                                            |
| `axi_araddr_i`          | Вход        | [31:0]   | AXI-адрес чтения                                                        |
| `axi_arid_i`            | Вход        | [3:0]    | AXI-ID транзакции чтения                                                |
| `axi_arlen_i`           | Вход        | [7:0]    | Длина burst-чтения                                                      |
| `axi_arburst_i`         | Вход        | [1:0]    | Тип burst-чтения                                                        |
| `axi_rready_i`          | Вход        | 1 бит    | Готовность принять данные чтения                                        |
| `axi_awready_o`         | Выход       | 1 бит    | Готовность принять адрес записи                                         |
| `axi_wready_o`          | Выход       | 1 бит    | Готовность принять данные записи                                        |
| `axi_bvalid_o`          | Выход       | 1 бит    | Валидность ответа записи                                                |
| `axi_bresp_o`           | Выход       | [1:0]    | Статус ответа записи (00-OK, 01-ERR, 10-SLVERR, 11-DECERR)              |
| `axi_bid_o`             | Выход       | [3:0]    | ID ответа записи                                                        |
| `axi_arready_o`         | Выход       | 1 бит    | Готовность принять адрес чтения                                         |
| `axi_rvalid_o`          | Выход       | 1 бит    | Валидность данных чтения                                                |
| `axi_rdata_o`           | Выход       | [31:0]   | AXI-данные чтения                                                       |
| `axi_rresp_o`           | Выход       | [1:0]    | Статус чтения                                                           |
| `axi_rid_o`             | Выход       | [3:0]    | ID ответа чтения                                                        |
| `axi_rlast_o`           | Выход       | 1 бит    | Флаг последнего пакета в burst-чтении                                   |

Логика работы:
Мультиплексирует доступ к RAM между ядром и AXI.
Инструкции читаются через отдельный порт (mem_i_pc_i).


__Подмодуль tcm_mem_ram__

Назначение:
Обрабатывает AXI-транзакции для TCM-памяти. Поддерживает burst-доступ (INCR, WRAP).

Ключевые сигналы:

| Сигнал               | Направление | Тип     | Описание                          |
|----------------------|-------------|---------|-----------------------------------|
| clk0_i              | Вход        | 1 бит   | Такт порта 0                      |
| clk1_i              | Вход        | 1 бит   | Такт порта 1                      |
| addr0_i             | Вход        | [12:0]  | Адрес порта 0                     |
| addr1_i             | Вход        | [12:0]  | Адрес порта 1                     |
| wr1_i               | Вход        | [7:0]   | Маска записи порта 1              |
| data0_o             | Выход       | [63:0]  | Данные порта 0                    |
| data1_o             | Выход       | [63:0]  | Данные порта 1                    |

Логика работы:

Обрабатывает AXI-запросы, преобразуя их в последовательные обращения к RAM.
Поддерживает приоритет между чтением и записью (round-robin).

__Подмодуль tcm_mem_pmem__
Назначение:
Dual-port RAM (64 КБ) для хранения данных. Один порт — для ядра, второй — для AXI.

Ключевые сигналы:

| Сигнал               | Направление | Тип     | Описание                          |
|----------------------|-------------|---------|-----------------------------------|
| clk_i               | Вход        | 1 бит   | Тактовый сигнал                   |
| rst_i               | Вход        | 1 бит   | Сигнал сброса                     |
| axi_awaddr_i        | Вход        | [31:0]  | AXI-адрес записи                  |
| axi_arlen_i         | Вход        | [7:0]   | Длина burst-чтения                |
| axi_awburst_i       | Вход        | [1:0]   | Тип burst-записи                  |
| ram_addr_o          | Выход       | [31:0]  | Адрес для RAM                     |
| ram_wr_o            | Выход       | [3:0]   | Маска записи                      |
| axi_rdata_o         | Выход       | [31:0]  | Данные чтения AXI                 |



#### 1.2.3 Реализация процессора с использованием ОЗУ

Архитектура RTL-процессора имеет следующую иерархическую структуру:

riscv_core[с общими модулями]
├── dcache
│ ├── dcache_if_pmem
│ │ └── dcache_if_pmem_fifo
│ ├── dcache_mux
│ ├── dcache_core
│ │ ├── dcache_core_tag_ram_0
│ │ ├── dcache_core_tag_ram_1
│ │ ├── dcache_core_data_ram_0
│ │ └── dcache_core_data_ram_1
│ ├── dcache_axi
│ │ ├──        dcache_axi_fifo
│ │ └──        dcache_axi_axi
│ └── dcache_pmem_mux
└── icache
    ├── icache_tag_ram_0
    ├── icache_tag_ram_1
    ├── icache_data_ram_0
    └── icache_data_ram_1

Структурная схема дизайна с использованием кешей представлена на изображении xxx

![](../birisc_v%20description/Images/riscv_top.png)
